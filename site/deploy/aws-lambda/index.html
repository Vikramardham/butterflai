
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ButterflAI" name="description"/>
<link href="https://Vikramardham.github.io/butterflai/deploy/aws-lambda/" rel="canonical"/>
<link href="../mlops-fundamentals/" rel="prev"/>
<link href="../../blog/" rel="next"/>
<link href="../../assets/logo.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.9" name="generator"/>
<title>LLM Service on AWS Lambda - ButterflAI</title>
<link href="../../assets/stylesheets/main.4af4bdda.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></link></head>
<body data-md-color-accent="purple" data-md-color-primary="teal" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#integrating-llms-into-enterprise-infrastructure-with-aws-lambda">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="ButterflAI" class="md-header__button md-logo" data-md-component="logo" href="../.." title="ButterflAI">
<img alt="logo" src="../../assets/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            ButterflAI
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              LLM Service on AWS Lambda
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="purple" data-md-color-media="" data-md-color-primary="teal" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="" data-md-color-primary="teal" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../build/">
          
  
  Build

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  Deploy

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../blog/">
          
  
  Blog

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../team/">
        
  
    
  
  Team

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../testimonials/">
        
  
    
  
  Testimonials

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../contact/">
        
  
    
  
  Contact

      </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="ButterflAI" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="ButterflAI">
<img alt="logo" src="../../assets/logo.png"/>
</a>
    ButterflAI
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Build
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Build
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/java/">
<span class="md-ellipsis">
    LLMs with Java
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/development-environment/">
<span class="md-ellipsis">
    Development Environment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/choosing-frameworks/index.md">
<span class="md-ellipsis">
    Framework Selection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/data-pipeline-best-practices/index.md">
<span class="md-ellipsis">
    Data Pipeline Best Practices
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/model-training-strategies/index.md">
<span class="md-ellipsis">
    Model Training Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
<span class="md-ellipsis">
    Topics
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
            Topics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/topic/data-preparation/index.md">
<span class="md-ellipsis">
    Data Preparation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/topic/model-architecture/index.md">
<span class="md-ellipsis">
    Model Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/topic/training-techniques/index.md">
<span class="md-ellipsis">
    Training Techniques
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/topic/testing-validation/index.md">
<span class="md-ellipsis">
    Testing &amp; Validation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build/topic/performance-optimization/index.md">
<span class="md-ellipsis">
    Performance Optimization
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    Deploy
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Deploy
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mlops-fundamentals/">
<span class="md-ellipsis">
    MLOps Fundamentals
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../containerizing-ai-apps/index.md">
<span class="md-ellipsis">
    Containerizing AI Applications
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cloud-deployment-options/index.md">
<span class="md-ellipsis">
    Cloud Deployment Options
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../monitoring-ai-systems/index.md">
<span class="md-ellipsis">
    Monitoring AI Systems
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    LLM Service on AWS Lambda
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    LLM Service on AWS Lambda
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-integration-challenge">
<span class="md-ellipsis">
      The Integration Challenge
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-serverless-llm-document-processor">
<span class="md-ellipsis">
      Building a Serverless LLM Document Processor
    </span>
</a>
<nav aria-label="Building a Serverless LLM Document Processor" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#project-structure">
<span class="md-ellipsis">
      Project Structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-up-the-fastapi-app">
<span class="md-ellipsis">
      Setting Up the FastAPI App
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#document-processing-models">
<span class="md-ellipsis">
      Document Processing Models
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-document-processor">
<span class="md-ellipsis">
      The Document Processor
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#containerizing-the-lambda-function">
<span class="md-ellipsis">
      Containerizing the Lambda Function
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploying-the-solution">
<span class="md-ellipsis">
      Deploying the Solution
    </span>
</a>
<nav aria-label="Deploying the Solution" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#infrastructure-as-code-with-terraform">
<span class="md-ellipsis">
      Infrastructure as Code with Terraform
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-and-using-the-api">
<span class="md-ellipsis">
      Testing and Using the API
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#benefits-of-this-approach">
<span class="md-ellipsis">
      Benefits of This Approach
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-with-existing-systems">
<span class="md-ellipsis">
      Integration with Existing Systems
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion-and-future-directions">
<span class="md-ellipsis">
      Conclusion and Future Directions
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="">
<span class="md-ellipsis">
    Topics
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            Topics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../topic/infrastructure-as-code/index.md">
<span class="md-ellipsis">
    Infrastructure as Code
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../topic/cicd-for-ai/index.md">
<span class="md-ellipsis">
    CI/CD for AI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../topic/scaling-strategies/index.md">
<span class="md-ellipsis">
    Scaling Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../topic/security-best-practices/index.md">
<span class="md-ellipsis">
    Security Best Practices
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Blog
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Blog
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
<span class="md-ellipsis">
    LLMs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
            LLMs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/getting-started-with-llms/">
<span class="md-ellipsis">
    Getting Started with LLMs
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/advanced-prompt-engineering/index.md">
<span class="md-ellipsis">
    Advanced Prompt Engineering
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/fine-tuning-llms/index.md">
<span class="md-ellipsis">
    Fine-tuning LLMs
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/building-rag-systems/index.md">
<span class="md-ellipsis">
    Building RAG Systems
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
<span class="md-ellipsis">
    AI Applications
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
            AI Applications
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/ai-for-customer-service/index.md">
<span class="md-ellipsis">
    AI for Customer Service
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/future-of-computer-vision/index.md">
<span class="md-ellipsis">
    The Future of Computer Vision
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/responsible-ai-systems/index.md">
<span class="md-ellipsis">
    Building Responsible AI Systems
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
<span class="md-ellipsis">
    Categories
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
            Categories
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/category/machine-learning/index.md">
<span class="md-ellipsis">
    Machine Learning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/category/nlp/index.md">
<span class="md-ellipsis">
    Natural Language Processing
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/category/computer-vision/index.md">
<span class="md-ellipsis">
    Computer Vision
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../blog/category/mlops/index.md">
<span class="md-ellipsis">
    MLOps
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../team/">
<span class="md-ellipsis">
    Team
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../testimonials/">
<span class="md-ellipsis">
    Testimonials
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../contact/">
<span class="md-ellipsis">
    Contact
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-integration-challenge">
<span class="md-ellipsis">
      The Integration Challenge
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-a-serverless-llm-document-processor">
<span class="md-ellipsis">
      Building a Serverless LLM Document Processor
    </span>
</a>
<nav aria-label="Building a Serverless LLM Document Processor" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#project-structure">
<span class="md-ellipsis">
      Project Structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-up-the-fastapi-app">
<span class="md-ellipsis">
      Setting Up the FastAPI App
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#document-processing-models">
<span class="md-ellipsis">
      Document Processing Models
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-document-processor">
<span class="md-ellipsis">
      The Document Processor
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#containerizing-the-lambda-function">
<span class="md-ellipsis">
      Containerizing the Lambda Function
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploying-the-solution">
<span class="md-ellipsis">
      Deploying the Solution
    </span>
</a>
<nav aria-label="Deploying the Solution" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#infrastructure-as-code-with-terraform">
<span class="md-ellipsis">
      Infrastructure as Code with Terraform
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-and-using-the-api">
<span class="md-ellipsis">
      Testing and Using the API
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#benefits-of-this-approach">
<span class="md-ellipsis">
      Benefits of This Approach
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-with-existing-systems">
<span class="md-ellipsis">
      Integration with Existing Systems
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion-and-future-directions">
<span class="md-ellipsis">
      Conclusion and Future Directions
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="integrating-llms-into-enterprise-infrastructure-with-aws-lambda">Integrating LLMs into Enterprise Infrastructure with AWS Lambda</h1>
<p>In today's rapidly evolving AI landscape, integrating Large Language Models (LLMs) into existing enterprise infrastructure presents a significant challenge. Organizations face a dilemma: they need the cutting-edge capabilities of modern LLMs, but their existing systems may not easily accommodate the Python ecosystem where most LLM advancements occur.</p>
<p>This article explores a practical solution to this challenge: using AWS Lambda functions as a bridge between your existing infrastructure and Python-based LLM capabilities. We'll cover the technical details of building, deploying, and consuming a serverless LLM API that can process various document types while minimizing impact on your current systems.</p>
<h2 id="the-integration-challenge">The Integration Challenge</h2>
<p>Enterprise systems often run on established platforms like Java, .NET, or legacy systems that may not easily integrate with Python-based LLM libraries. However, Python has become the de facto standard for AI development due to:</p>
<ol>
<li><strong>Rapid innovation</strong>: Most cutting-edge LLM libraries appear first in Python</li>
<li><strong>Rich ecosystem</strong>: Tools like LangChain, LlamaIndex, and instructor-embedding are Python-first</li>
<li><strong>Direct model access</strong>: Python SDKs for OpenAI, Anthropic, and other providers are more mature</li>
<li><strong>Community support</strong>: The AI community primarily shares solutions in Python</li>
</ol>
<p>Rather than rewriting existing systems or waiting for LLM libraries to mature in other languages, AWS Lambda offers an elegant solution:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-type="image" data-width="auto" href="https://mermaid.ink/img/pako:eNqNkk9rwzAMxb-K0E4dJPuXXXJoSw87lA2G2tMYwrZSG5rYwXYGpfS7z06zoWSF7WRL0k9683Rh0gqgHpfcbDQb1ZYXHnrIy4Kh4GWdjkk2oe46d4w36fHrJXBcRxNGIyIY1yDyBCZJkkzJpWVBXDPnQRvLZWVRPChHEr6xljK5cCiZ96iEcn3qSbfOaJpNkN-BJ3sxiOEi_b5B2Pt_yrxC6PAFVx2uScMhQ2tIOkEOEXQtRrlwxtA7l1h_5r90mfaywDUUZm9dURsU1JN2Y4w15A5ZGnlB4q0yRZPMfjCYZPEkDSSUzhrV0hLUgO44SXFCwDzXtpchY1HO47EYUW82m_mMumaF1uDG8ylnHr2BHNP9SdWCejgUVlU3aJm3qCKjPcXJBxXcr-AXvWfSag?type=png"><img alt="LLM Lambda Architecture" src="https://mermaid.ink/img/pako:eNqNkk9rwzAMxb-K0E4dJPuXXXJoSw87lA2G2tMYwrZSG5rYwXYGpfS7z06zoWSF7WRL0k9683Rh0gqgHpfcbDQb1ZYXHnrIy4Kh4GWdjkk2oe46d4w36fHrJXBcRxNGIyIY1yDyBCZJkkzJpWVBXDPnQRvLZWVRPChHEr6xljK5cCiZ96iEcn3qSbfOaJpNkN-BJ3sxiOEi_b5B2Pt_yrxC6PAFVx2uScMhQ2tIOkEOEXQtRrlwxtA7l1h_5r90mfaywDUUZm9dURsU1JN2Y4w15A5ZGnlB4q0yRZPMfjCYZPEkDSSUzhrV0hLUgO44SXFCwDzXtpchY1HO47EYUW82m_mMumaF1uDG8ylnHr2BHNP9SdWCejgUVlU3aJm3qCKjPcXJBxXcr-AXvWfSag?type=png"/></a></p>
<h2 id="building-a-serverless-llm-document-processor">Building a Serverless LLM Document Processor</h2>
<p>Let's create a Python-based LLM service on AWS Lambda that can:</p>
<ol>
<li>Process various document types (JSON, images, PDFs)</li>
<li>Apply LLM capabilities for analysis</li>
<li>Return structured responses</li>
<li>Offer a secure, scalable HTTP API endpoint</li>
</ol>
<h3 id="project-structure">Project Structure</h3>
<p>Our project follows this structure:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>.
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>├── src/
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>│   ├── lambda_functions/        # AWS Lambda function implementations
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>│   │   └── document_processor/  # Document processing function
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>│   ├── utils/                   # Shared utility modules
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>│   └── config/                  # Configuration modules
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>├── scripts/                     # Deployment and utility scripts
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>├── terraform/                   # Infrastructure as code
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>├── examples/                    # Example usage scripts
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>├── Dockerfile                   # Container definition for Lambda
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>└── lambda_entry.py              # Local Lambda testing script
</code></pre></div>
<h3 id="setting-up-the-fastapi-app">Setting Up the FastAPI App</h3>
<p>We'll use FastAPI to create a web service that AWS Lambda can run. This approach gives us the best of both worlds:</p>
<ol>
<li>Local development using standard web frameworks</li>
<li>Serverless deployment through AWS Lambda</li>
</ol>
<p>Here's our main application file (<code>src/lambda_functions/document_processor/app.py</code>):</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="sd">"""</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="sd">FastAPI app for local development and Lambda deployment.</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="sd">"""</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="c1"># Add parent directories to Python path for proper imports</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="n">lambda_functions_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">current_dir</span><span class="p">))</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="n">src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lambda_functions_dir</span><span class="p">)</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src_dir</span><span class="p">)</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="c1"># Add directories to Python path if not already there</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">lambda_functions_dir</span><span class="p">,</span> <span class="n">src_dir</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">]:</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="k">if</span> <span class="n">directory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="c1"># Import application components</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">mangum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mangum</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.lambda_functions.document_processor.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="n">DocumentProcessRequest</span><span class="p">,</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="n">DocumentProcessResponse</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>    <span class="p">)</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.lambda_functions.document_processor.processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentProcessor</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.lambda_functions.document_processor.handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">lambda_handler</span>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>    <span class="c1"># Create FastAPI app</span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="n">title</span><span class="o">=</span><span class="s2">"Document Processor API"</span><span class="p">,</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">"API for processing documents with LLM"</span><span class="p">,</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">"0.1.0"</span>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>    <span class="p">)</span>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Document Processor API is running"</span><span class="p">}</span>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/process"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">DocumentProcessResponse</span><span class="p">)</span>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_document</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">DocumentProcessRequest</span><span class="p">):</span>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">        </span><span class="sd">"""</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="sd">        Process a document with LLM and return structured analysis.</span>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="sd">        """</span>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>        <span class="n">processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>        <span class="k">return</span> <span class="n">response</span>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>    <span class="c1"># Create a wrapper function that can handle multiple event types</span>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">universal_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">        </span><span class="sd">"""Wrapper handler that can process different event types."""</span>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>        <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>            <span class="c1"># Check if the event is a direct invocation with document data</span>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>            <span class="k">if</span> <span class="s2">"document_data"</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">"instructions"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">DocumentProcessRequest</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>                <span class="n">processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>                <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>                    <span class="s2">"statusCode"</span><span class="p">:</span> <span class="mi">200</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="mi">500</span><span class="p">,</span>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>                    <span class="s2">"body"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>                <span class="p">}</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>            <span class="c1"># Check if this is API Gateway 1.0 format</span>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>            <span class="k">if</span> <span class="s2">"httpMethod"</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">and</span> <span class="s2">"body"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>                <span class="k">return</span> <span class="n">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>            <span class="c1"># Default to Mangum for API Gateway v2</span>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>            <span class="n">mangum_handler</span> <span class="o">=</span> <span class="n">Mangum</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>            <span class="k">return</span> <span class="n">mangum_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>
<a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>            <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>                <span class="s2">"statusCode"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
<a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>                <span class="s2">"body"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>                    <span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>                    <span class="s2">"traceback"</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
<a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>                <span class="p">})</span>
<a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>            <span class="p">}</span>
<a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>
<a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a>    <span class="c1"># Use the universal handler</span>
<a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>    <span class="n">handler</span> <span class="o">=</span> <span class="n">universal_handler</span>
<a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>
<a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a>    <span class="c1"># Simple fallback handler if imports fail</span>
<a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>            <span class="s2">"statusCode"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
<a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>            <span class="s2">"body"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>                <span class="s2">"error"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Failed to initialize Lambda: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>            <span class="p">})</span>
<a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>        <span class="p">}</span>
</code></pre></div>
<p>This sets up a FastAPI application with a <code>/process</code> endpoint that accepts document data and returns structured LLM analysis.</p>
<h3 id="document-processing-models">Document Processing Models</h3>
<p>Let's define the data models to handle document processing requests and responses:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># src/lambda_functions/document_processor/models.py</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentProcessRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="sd">"""Request model for document processing."""</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="n">document_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">"Document data (base64-encoded for binary formats)"</span><span class="p">)</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="n">document_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s2">"json"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">"Document type (json, image, pdf)"</span><span class="p">)</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="n">llm_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s2">"openai"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">"LLM provider to use"</span><span class="p">)</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="n">instructions</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">"Processing instructions for the LLM"</span><span class="p">)</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">TextAnnotation</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="sd">"""Text annotation from document processing."""</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">EntityAnnotation</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="sd">"""Entity annotation from document processing."""</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>    <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentSummary</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="sd">"""Document summary."""</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProcessResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">    </span><span class="sd">"""Result of document processing."""</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>    <span class="n">summary</span><span class="p">:</span> <span class="n">DocumentSummary</span>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>    <span class="n">text_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TextAnnotation</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>    <span class="n">entity_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EntityAnnotation</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentProcessResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">    </span><span class="sd">"""Response model for document processing."""</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>    <span class="n">error_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>    <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProcessResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<h3 id="the-document-processor">The Document Processor</h3>
<p>Now, let's create the processor that will use LLMs to analyze documents:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># src/lambda_functions/document_processor/processor.py</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.lambda_functions.document_processor.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">DocumentProcessRequest</span><span class="p">,</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">DocumentProcessResponse</span><span class="p">,</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="n">ProcessResult</span><span class="p">,</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="n">DocumentSummary</span><span class="p">,</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="n">TextAnnotation</span><span class="p">,</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="n">EntityAnnotation</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">)</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.llm_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMClient</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">DocumentProcessor</span><span class="p">:</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="sd">"""Processes documents with LLM and returns structured analysis."""</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">DocumentProcessRequest</span><span class="p">):</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">LLMClient</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">llm_provider</span><span class="p">)</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DocumentProcessResponse</span><span class="p">:</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="sd">"""Process the document and return a structured response."""</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>        <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>            <span class="c1"># Decode document data based on type</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>            <span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_document</span><span class="p">()</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>            <span class="c1"># Process with LLM</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>            <span class="n">llm_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">process_document</span><span class="p">(</span>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>                <span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>                <span class="n">doc_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_type</span><span class="p">,</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>                <span class="n">instructions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">instructions</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>            <span class="p">)</span>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>            <span class="c1"># Parse LLM response into structured output</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_llm_response</span><span class="p">(</span><span class="n">llm_response</span><span class="p">)</span>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>            <span class="k">return</span> <span class="n">DocumentProcessResponse</span><span class="p">(</span>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>                <span class="n">request_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>            <span class="p">)</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>            <span class="k">return</span> <span class="n">DocumentProcessResponse</span><span class="p">(</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>                <span class="n">request_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>                <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>            <span class="p">)</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">        </span><span class="sd">"""Decode document data based on type."""</span>
<a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_type</span> <span class="o">==</span> <span class="s2">"json"</span><span class="p">:</span>
<a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_data</span><span class="p">)</span>
<a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"image"</span><span class="p">,</span> <span class="s2">"pdf"</span><span class="p">]:</span>
<a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>            <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_data</span><span class="p">)</span>
<a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">document_data</span>
<a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a>
<a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_llm_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessResult</span><span class="p">:</span>
<a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="w">        </span><span class="sd">"""Parse LLM response into structured output."""</span>
<a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a>        <span class="c1"># Example implementation - in a real app, you would parse </span>
<a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>        <span class="c1"># the actual LLM response based on your schema</span>
<a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>        <span class="k">return</span> <span class="n">ProcessResult</span><span class="p">(</span>
<a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a>            <span class="n">summary</span><span class="o">=</span><span class="n">DocumentSummary</span><span class="p">(</span>
<a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a>                <span class="n">title</span><span class="o">=</span><span class="n">llm_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Document Analysis"</span><span class="p">),</span>
<a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a>                <span class="n">content</span><span class="o">=</span><span class="n">llm_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"summary"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>            <span class="p">),</span>
<a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>            <span class="n">text_annotations</span><span class="o">=</span><span class="p">[</span>
<a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a>                <span class="n">TextAnnotation</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">"type"</span><span class="p">],</span> <span class="n">content</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">"content"</span><span class="p">])</span>
<a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"annotations"</span><span class="p">,</span> <span class="p">[])</span>
<a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a>            <span class="p">],</span>
<a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>            <span class="n">entity_annotations</span><span class="o">=</span><span class="p">[</span>
<a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a>                <span class="n">EntityAnnotation</span><span class="p">(</span>
<a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>                    <span class="n">entity_type</span><span class="o">=</span><span class="n">entity</span><span class="p">[</span><span class="s2">"type"</span><span class="p">],</span>
<a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a>                    <span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
<a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a>                    <span class="n">value</span><span class="o">=</span><span class="n">entity</span><span class="p">[</span><span class="s2">"value"</span><span class="p">]</span>
<a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a>                <span class="p">)</span>
<a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>                <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"entities"</span><span class="p">,</span> <span class="p">[])</span>
<a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a>            <span class="p">]</span>
<a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="containerizing-the-lambda-function">Containerizing the Lambda Function</h3>
<p>Using Docker containers for Lambda deployment simplifies dependency management. Here's our <code>Dockerfile</code>:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">public.ecr.aws/lambda/python:3.10</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c"># Copy source code</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="k">COPY</span><span class="w"> </span>src/<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/src/
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="c"># Copy requirements and test scripts</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>lambda_entry.py<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c"># Install dependencies in the proper structure for Lambda</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt<span class="w"> </span>--target<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="c"># Install specific dependencies that might be causing issues</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nv">fastapi</span><span class="o">==</span><span class="m">0</span>.100.0<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="nv">mangum</span><span class="o">==</span><span class="m">0</span>.17.0<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="nv">pydantic</span><span class="o">==</span><span class="m">2</span>.4.0<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span>pydantic-core<span class="o">==</span><span class="m">2</span>.10.0<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="nv">starlette</span><span class="o">==</span><span class="m">0</span>.27.0<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span>--target<span class="w"> </span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>/
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="c"># Set the PYTHONPATH (for local testing)</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">LAMBDA_TASK_ROOT</span><span class="si">}</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="c"># Set the handler</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"src.lambda_functions.document_processor.app.handler"</span><span class="w"> </span><span class="p">]</span>
</code></pre></div>
<h2 id="deploying-the-solution">Deploying the Solution</h2>
<p>We'll use a comprehensive deployment script to handle the entire process:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c"># scripts/deploy.ps1</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">param</span> <span class="p">(</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="no">[string]</span><span class="nv">$AwsProfile</span> <span class="p">=</span> <span class="s2">"default"</span><span class="p">,</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="no">[string]</span><span class="nv">$AwsRegion</span> <span class="p">=</span> <span class="s2">"us-east-1"</span><span class="p">,</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="no">[string]</span><span class="nv">$RepositoryName</span> <span class="p">=</span> <span class="s2">"document-processor"</span><span class="p">,</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>    <span class="no">[switch]</span><span class="nv">$SkipImageBuild</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">,</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="no">[switch]</span><span class="nv">$SkipEcr</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">,</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>
<a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>    <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
<a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>    <span class="no">[switch]</span><span class="nv">$SkipTerraform</span> <span class="p">=</span> <span class="nv">$false</span>
<a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="p">)</span>
<a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>
<a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="c"># Function to display section headers</span>
<a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="k">function</span> <span class="nb">Write-Header</span> <span class="p">{</span>
<a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>    <span class="k">param</span> <span class="p">(</span><span class="no">[string]</span><span class="nv">$Text</span><span class="p">)</span>
<a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>    <span class="nb">Write-Host</span> <span class="s2">"</span><span class="se">`n</span><span class="s2">=== $Text ===</span><span class="se">`n</span><span class="s2">"</span> <span class="n">-ForegroundColor</span> <span class="n">Cyan</span>
<a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="p">}</span>
<a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a>
<a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="c"># Set AWS profile and verify credentials</span>
<a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="nv">$env:AWS_PROFILE</span> <span class="p">=</span> <span class="nv">$AwsProfile</span>
<a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="nv">$awsAccount</span> <span class="p">=</span> <span class="n">aws</span> <span class="n">sts</span> <span class="nb">get-caller</span><span class="n">-identity</span> <span class="p">-</span><span class="n">-query</span> <span class="s2">"Account"</span> <span class="p">-</span><span class="n">-output</span> <span class="n">text</span>
<a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="c"># Create or verify ECR repository if not skipped</span>
<a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$SkipEcr</span><span class="p">)</span> <span class="p">{</span>
<a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="nb">Write-Header</span> <span class="s2">"Setting Up ECR Repository"</span>
<a href="#__codelineno-5-35" id="__codelineno-5-35" name="__codelineno-5-35"></a>    <span class="c"># Check if repository exists, create if it doesn't</span>
<a href="#__codelineno-5-36" id="__codelineno-5-36" name="__codelineno-5-36"></a>    <span class="c"># ... (repository creation logic)</span>
<a href="#__codelineno-5-37" id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="p">}</span>
<a href="#__codelineno-5-38" id="__codelineno-5-38" name="__codelineno-5-38"></a>
<a href="#__codelineno-5-39" id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="c"># Build and push Docker image if not skipped</span>
<a href="#__codelineno-5-40" id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$SkipImageBuild</span><span class="p">)</span> <span class="p">{</span>
<a href="#__codelineno-5-41" id="__codelineno-5-41" name="__codelineno-5-41"></a>    <span class="nb">Write-Header</span> <span class="s2">"Building Docker Image"</span>
<a href="#__codelineno-5-42" id="__codelineno-5-42" name="__codelineno-5-42"></a>    <span class="n">docker</span> <span class="n">build</span> <span class="n">-t</span> <span class="nv">$RepositoryName</span> <span class="p">.</span> <span class="p">-</span><span class="n">-no-cache</span>
<a href="#__codelineno-5-43" id="__codelineno-5-43" name="__codelineno-5-43"></a>
<a href="#__codelineno-5-44" id="__codelineno-5-44" name="__codelineno-5-44"></a>    <span class="c"># Tag with timestamp and 'latest'</span>
<a href="#__codelineno-5-45" id="__codelineno-5-45" name="__codelineno-5-45"></a>    <span class="nv">$timestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="s2">"yyyyMMdd-HHmmss"</span>
<a href="#__codelineno-5-46" id="__codelineno-5-46" name="__codelineno-5-46"></a>    <span class="nv">$imageUri</span> <span class="p">=</span> <span class="s2">"${awsAccount}.dkr.ecr.${AwsRegion}.amazonaws.com/${RepositoryName}:${timestamp}"</span>
<a href="#__codelineno-5-47" id="__codelineno-5-47" name="__codelineno-5-47"></a>    <span class="nv">$latestImageUri</span> <span class="p">=</span> <span class="s2">"${awsAccount}.dkr.ecr.${AwsRegion}.amazonaws.com/${RepositoryName}:latest"</span>
<a href="#__codelineno-5-48" id="__codelineno-5-48" name="__codelineno-5-48"></a>
<a href="#__codelineno-5-49" id="__codelineno-5-49" name="__codelineno-5-49"></a>    <span class="n">docker</span> <span class="n">tag</span> <span class="nv">$RepositoryName</span> <span class="nv">$imageUri</span>
<a href="#__codelineno-5-50" id="__codelineno-5-50" name="__codelineno-5-50"></a>    <span class="n">docker</span> <span class="n">tag</span> <span class="nv">$RepositoryName</span> <span class="nv">$latestImageUri</span>
<a href="#__codelineno-5-51" id="__codelineno-5-51" name="__codelineno-5-51"></a>
<a href="#__codelineno-5-52" id="__codelineno-5-52" name="__codelineno-5-52"></a>    <span class="c"># Push to ECR</span>
<a href="#__codelineno-5-53" id="__codelineno-5-53" name="__codelineno-5-53"></a>    <span class="n">docker</span> <span class="n">push</span> <span class="nv">$imageUri</span>
<a href="#__codelineno-5-54" id="__codelineno-5-54" name="__codelineno-5-54"></a>    <span class="n">docker</span> <span class="n">push</span> <span class="nv">$latestImageUri</span>
<a href="#__codelineno-5-55" id="__codelineno-5-55" name="__codelineno-5-55"></a>
<a href="#__codelineno-5-56" id="__codelineno-5-56" name="__codelineno-5-56"></a>    <span class="c"># Create Terraform variables file</span>
<a href="#__codelineno-5-57" id="__codelineno-5-57" name="__codelineno-5-57"></a>    <span class="nv">$terraformVars</span> <span class="p">=</span> <span class="sh">@"</span>
<a href="#__codelineno-5-58" id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="sh"># Auto-generated by deploy.ps1</span>
<a href="#__codelineno-5-59" id="__codelineno-5-59" name="__codelineno-5-59"></a><span class="sh">container_image_uri = "$imageUri"</span>
<a href="#__codelineno-5-60" id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="sh">aws_profile = "$AwsProfile"</span>
<a href="#__codelineno-5-61" id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="sh">aws_region = "$AwsRegion"</span>
<a href="#__codelineno-5-62" id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="sh">api_stage = "dev"</span>
<a href="#__codelineno-5-63" id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="sh">"@</span>
<a href="#__codelineno-5-64" id="__codelineno-5-64" name="__codelineno-5-64"></a>
<a href="#__codelineno-5-65" id="__codelineno-5-65" name="__codelineno-5-65"></a>    <span class="nb">Set-Content</span> <span class="n">-Path</span> <span class="s2">"terraform/terraform.tfvars"</span> <span class="n">-Value</span> <span class="nv">$terraformVars</span>
<a href="#__codelineno-5-66" id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="p">}</span>
<a href="#__codelineno-5-67" id="__codelineno-5-67" name="__codelineno-5-67"></a>
<a href="#__codelineno-5-68" id="__codelineno-5-68" name="__codelineno-5-68"></a><span class="c"># Deploy with Terraform if not skipped</span>
<a href="#__codelineno-5-69" id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$SkipTerraform</span><span class="p">)</span> <span class="p">{</span>
<a href="#__codelineno-5-70" id="__codelineno-5-70" name="__codelineno-5-70"></a>    <span class="nb">Write-Header</span> <span class="s2">"Deploying with Terraform"</span>
<a href="#__codelineno-5-71" id="__codelineno-5-71" name="__codelineno-5-71"></a>
<a href="#__codelineno-5-72" id="__codelineno-5-72" name="__codelineno-5-72"></a>    <span class="nb">Push-Location</span> <span class="n">terraform</span>
<a href="#__codelineno-5-73" id="__codelineno-5-73" name="__codelineno-5-73"></a>    <span class="n">terraform</span> <span class="n">init</span>
<a href="#__codelineno-5-74" id="__codelineno-5-74" name="__codelineno-5-74"></a>    <span class="n">terraform</span> <span class="n">plan</span> <span class="n">-out</span><span class="p">=</span><span class="s2">"tf-plan"</span>
<a href="#__codelineno-5-75" id="__codelineno-5-75" name="__codelineno-5-75"></a>    <span class="n">terraform</span> <span class="n">apply</span> <span class="s2">"tf-plan"</span>
<a href="#__codelineno-5-76" id="__codelineno-5-76" name="__codelineno-5-76"></a>    <span class="nb">Pop-Location</span>
<a href="#__codelineno-5-77" id="__codelineno-5-77" name="__codelineno-5-77"></a><span class="p">}</span>
</code></pre></div>
<h3 id="infrastructure-as-code-with-terraform">Infrastructure as Code with Terraform</h3>
<p>Our Terraform code provisions the AWS resources needed:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># terraform/main.tf</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"container_image_uri"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ECR image URI for the Lambda function"</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="p">}</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"aws_region"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AWS region"</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"us-east-1"</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="p">}</span>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"aws_profile"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AWS profile"</span>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"default"</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="p">}</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"api_stage"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"API Gateway stage name"</span>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"dev"</span>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="p">}</span>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">"aws"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">  </span><span class="na">region</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_region</span>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">  </span><span class="na">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_profile</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="p">}</span>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="c1"># Create Lambda function</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_lambda_function"</span><span class="w"> </span><span class="nv">"document_processor"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"document-processor"</span>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">  </span><span class="na">package_type</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"Image"</span>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">  </span><span class="na">image_uri</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.container_image_uri</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">  </span><span class="na">timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">30</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">  </span><span class="na">memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1024</span>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">  </span><span class="na">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.lambda_exec.arn</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">  </span><span class="nb">environment</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="nb">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">      </span><span class="na">ENVIRONMENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.api_stage</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">  </span><span class="p">}</span>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="p">}</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="c1"># IAM role for Lambda</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_role"</span><span class="w"> </span><span class="nv">"lambda_exec"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"document-processor-lambda-role"</span>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2012-10-17"</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">      </span><span class="p">{</span>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span>
<a href="#__codelineno-6-56" id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-57" id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lambda.amazonaws.com"</span>
<a href="#__codelineno-6-58" id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-6-59" id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Allow"</span>
<a href="#__codelineno-6-60" id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="w">      </span><span class="p">}</span>
<a href="#__codelineno-6-61" id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">    </span><span class="p">]</span>
<a href="#__codelineno-6-62" id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">  </span><span class="p">})</span>
<a href="#__codelineno-6-63" id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="p">}</span>
<a href="#__codelineno-6-64" id="__codelineno-6-64" name="__codelineno-6-64"></a>
<a href="#__codelineno-6-65" id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="c1"># Attach policies to Lambda role</span>
<a href="#__codelineno-6-66" id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_role_policy_attachment"</span><span class="w"> </span><span class="nv">"lambda_basic"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-67" id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.lambda_exec.name</span>
<a href="#__codelineno-6-68" id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>
<a href="#__codelineno-6-69" id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="p">}</span>
<a href="#__codelineno-6-70" id="__codelineno-6-70" name="__codelineno-6-70"></a>
<a href="#__codelineno-6-71" id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_role_policy_attachment"</span><span class="w"> </span><span class="nv">"secrets_manager_read"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-72" id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.lambda_exec.name</span>
<a href="#__codelineno-6-73" id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_policy.secrets_manager_read.arn</span>
<a href="#__codelineno-6-74" id="__codelineno-6-74" name="__codelineno-6-74"></a><span class="p">}</span>
<a href="#__codelineno-6-75" id="__codelineno-6-75" name="__codelineno-6-75"></a>
<a href="#__codelineno-6-76" id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="c1"># Policy for reading from Secrets Manager</span>
<a href="#__codelineno-6-77" id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_iam_policy"</span><span class="w"> </span><span class="nv">"secrets_manager_read"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-78" id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"document-processor-secrets-read"</span>
<a href="#__codelineno-6-79" id="__codelineno-6-79" name="__codelineno-6-79"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Allow Lambda to read API keys from Secrets Manager"</span>
<a href="#__codelineno-6-80" id="__codelineno-6-80" name="__codelineno-6-80"></a>
<a href="#__codelineno-6-81" id="__codelineno-6-81" name="__codelineno-6-81"></a><span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<a href="#__codelineno-6-82" id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2012-10-17"</span>
<a href="#__codelineno-6-83" id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a href="#__codelineno-6-84" id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">      </span><span class="p">{</span>
<a href="#__codelineno-6-85" id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a href="#__codelineno-6-86" id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">          </span><span class="s2">"secretsmanager:GetSecretValue"</span><span class="p">,</span>
<a href="#__codelineno-6-87" id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">        </span><span class="p">]</span>
<a href="#__codelineno-6-88" id="__codelineno-6-88" name="__codelineno-6-88"></a><span class="w">        </span><span class="na">Resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"arn:aws:secretsmanager:${var.aws_region}:*:secret:llm-utilities/api-keys*"</span>
<a href="#__codelineno-6-89" id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">        </span><span class="na">Effect</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">"Allow"</span>
<a href="#__codelineno-6-90" id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">      </span><span class="p">}</span>
<a href="#__codelineno-6-91" id="__codelineno-6-91" name="__codelineno-6-91"></a><span class="w">    </span><span class="p">]</span>
<a href="#__codelineno-6-92" id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">  </span><span class="p">})</span>
<a href="#__codelineno-6-93" id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="p">}</span>
<a href="#__codelineno-6-94" id="__codelineno-6-94" name="__codelineno-6-94"></a>
<a href="#__codelineno-6-95" id="__codelineno-6-95" name="__codelineno-6-95"></a><span class="c1"># API Gateway REST API</span>
<a href="#__codelineno-6-96" id="__codelineno-6-96" name="__codelineno-6-96"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_apigatewayv2_api"</span><span class="w"> </span><span class="nv">"api"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-97" id="__codelineno-6-97" name="__codelineno-6-97"></a><span class="w">  </span><span class="na">name</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"document-processor-api"</span>
<a href="#__codelineno-6-98" id="__codelineno-6-98" name="__codelineno-6-98"></a><span class="w">  </span><span class="na">protocol_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HTTP"</span>
<a href="#__codelineno-6-99" id="__codelineno-6-99" name="__codelineno-6-99"></a><span class="p">}</span>
<a href="#__codelineno-6-100" id="__codelineno-6-100" name="__codelineno-6-100"></a>
<a href="#__codelineno-6-101" id="__codelineno-6-101" name="__codelineno-6-101"></a><span class="c1"># API Gateway stage</span>
<a href="#__codelineno-6-102" id="__codelineno-6-102" name="__codelineno-6-102"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_apigatewayv2_stage"</span><span class="w"> </span><span class="nv">"stage"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-103" id="__codelineno-6-103" name="__codelineno-6-103"></a><span class="w">  </span><span class="na">api_id</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_apigatewayv2_api.api.id</span>
<a href="#__codelineno-6-104" id="__codelineno-6-104" name="__codelineno-6-104"></a><span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.api_stage</span>
<a href="#__codelineno-6-105" id="__codelineno-6-105" name="__codelineno-6-105"></a><span class="w">  </span><span class="na">auto_deploy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a href="#__codelineno-6-106" id="__codelineno-6-106" name="__codelineno-6-106"></a><span class="p">}</span>
<a href="#__codelineno-6-107" id="__codelineno-6-107" name="__codelineno-6-107"></a>
<a href="#__codelineno-6-108" id="__codelineno-6-108" name="__codelineno-6-108"></a><span class="c1"># API Gateway Lambda integration</span>
<a href="#__codelineno-6-109" id="__codelineno-6-109" name="__codelineno-6-109"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_apigatewayv2_integration"</span><span class="w"> </span><span class="nv">"lambda_integration"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-110" id="__codelineno-6-110" name="__codelineno-6-110"></a><span class="w">  </span><span class="na">api_id</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_apigatewayv2_api.api.id</span>
<a href="#__codelineno-6-111" id="__codelineno-6-111" name="__codelineno-6-111"></a><span class="w">  </span><span class="na">integration_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AWS_PROXY"</span>
<a href="#__codelineno-6-112" id="__codelineno-6-112" name="__codelineno-6-112"></a>
<a href="#__codelineno-6-113" id="__codelineno-6-113" name="__codelineno-6-113"></a><span class="w">  </span><span class="na">integration_uri</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.document_processor.invoke_arn</span>
<a href="#__codelineno-6-114" id="__codelineno-6-114" name="__codelineno-6-114"></a><span class="w">  </span><span class="na">integration_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"POST"</span>
<a href="#__codelineno-6-115" id="__codelineno-6-115" name="__codelineno-6-115"></a><span class="w">  </span><span class="na">payload_format_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2.0"</span>
<a href="#__codelineno-6-116" id="__codelineno-6-116" name="__codelineno-6-116"></a><span class="p">}</span>
<a href="#__codelineno-6-117" id="__codelineno-6-117" name="__codelineno-6-117"></a>
<a href="#__codelineno-6-118" id="__codelineno-6-118" name="__codelineno-6-118"></a><span class="c1"># API Gateway routes</span>
<a href="#__codelineno-6-119" id="__codelineno-6-119" name="__codelineno-6-119"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_apigatewayv2_route"</span><span class="w"> </span><span class="nv">"route"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-120" id="__codelineno-6-120" name="__codelineno-6-120"></a><span class="w">  </span><span class="na">api_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_apigatewayv2_api.api.id</span>
<a href="#__codelineno-6-121" id="__codelineno-6-121" name="__codelineno-6-121"></a><span class="w">  </span><span class="na">route_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ANY /{proxy+}"</span>
<a href="#__codelineno-6-122" id="__codelineno-6-122" name="__codelineno-6-122"></a>
<a href="#__codelineno-6-123" id="__codelineno-6-123" name="__codelineno-6-123"></a><span class="w">  </span><span class="na">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"integrations/${aws_apigatewayv2_integration.lambda_integration.id}"</span>
<a href="#__codelineno-6-124" id="__codelineno-6-124" name="__codelineno-6-124"></a><span class="p">}</span>
<a href="#__codelineno-6-125" id="__codelineno-6-125" name="__codelineno-6-125"></a>
<a href="#__codelineno-6-126" id="__codelineno-6-126" name="__codelineno-6-126"></a><span class="c1"># Lambda permission for API Gateway</span>
<a href="#__codelineno-6-127" id="__codelineno-6-127" name="__codelineno-6-127"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">"aws_lambda_permission"</span><span class="w"> </span><span class="nv">"api_gateway"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-128" id="__codelineno-6-128" name="__codelineno-6-128"></a><span class="w">  </span><span class="na">statement_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">"AllowExecutionFromAPIGateway"</span>
<a href="#__codelineno-6-129" id="__codelineno-6-129" name="__codelineno-6-129"></a><span class="w">  </span><span class="na">action</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"lambda:InvokeFunction"</span>
<a href="#__codelineno-6-130" id="__codelineno-6-130" name="__codelineno-6-130"></a><span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.document_processor.function_name</span>
<a href="#__codelineno-6-131" id="__codelineno-6-131" name="__codelineno-6-131"></a><span class="w">  </span><span class="na">principal</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">"apigateway.amazonaws.com"</span>
<a href="#__codelineno-6-132" id="__codelineno-6-132" name="__codelineno-6-132"></a>
<a href="#__codelineno-6-133" id="__codelineno-6-133" name="__codelineno-6-133"></a><span class="w">  </span><span class="na">source_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${aws_apigatewayv2_api.api.execution_arn}/*/*"</span>
<a href="#__codelineno-6-134" id="__codelineno-6-134" name="__codelineno-6-134"></a><span class="p">}</span>
<a href="#__codelineno-6-135" id="__codelineno-6-135" name="__codelineno-6-135"></a>
<a href="#__codelineno-6-136" id="__codelineno-6-136" name="__codelineno-6-136"></a><span class="c1"># Output API endpoint</span>
<a href="#__codelineno-6-137" id="__codelineno-6-137" name="__codelineno-6-137"></a><span class="kr">output</span><span class="w"> </span><span class="nv">"api_endpoint"</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-6-138" id="__codelineno-6-138" name="__codelineno-6-138"></a><span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"${aws_apigatewayv2_stage.stage.invoke_url}"</span>
<a href="#__codelineno-6-139" id="__codelineno-6-139" name="__codelineno-6-139"></a><span class="p">}</span>
</code></pre></div>
<h2 id="testing-and-using-the-api">Testing and Using the API</h2>
<p>Once deployed, we can test our Lambda-based API:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># examples/test_document_processor.py</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">():</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Test the document processor API"</span><span class="p">)</span>
<a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--api-url"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"API Gateway URL"</span><span class="p">)</span>
<a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--test-type"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">"json"</span><span class="p">,</span> <span class="s2">"image"</span><span class="p">,</span> <span class="s2">"pdf"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">"json"</span><span class="p">,</span>
<a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>                      <span class="n">help</span><span class="o">=</span><span class="s2">"Type of test to run (default: json)"</span><span class="p">)</span>
<a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>
<a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_json_processing</span><span class="p">(</span><span class="n">api_url</span><span class="p">):</span>
<a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="c1"># Example JSON data</span>
<a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>        <span class="s2">"customer"</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>            <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"C1234"</span><span class="p">,</span>
<a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Jane Smith"</span>
<a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>        <span class="p">},</span>
<a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>        <span class="s2">"order"</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>            <span class="s2">"items"</span><span class="p">:</span> <span class="p">[</span>
<a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>                <span class="p">{</span><span class="s2">"product"</span><span class="p">:</span> <span class="s2">"Laptop"</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">:</span> <span class="mf">1299.99</span><span class="p">},</span>
<a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a>                <span class="p">{</span><span class="s2">"product"</span><span class="p">:</span> <span class="s2">"Mouse"</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">:</span> <span class="mf">24.99</span><span class="p">}</span>
<a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a>            <span class="p">],</span>
<a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a>            <span class="s2">"total"</span><span class="p">:</span> <span class="mf">1324.98</span>
<a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="p">}</span>
<a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a>    <span class="p">}</span>
<a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>
<a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a>    <span class="c1"># Prepare the request payload</span>
<a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>        <span class="s2">"document_data"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">test_data</span><span class="p">),</span>
<a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>        <span class="s2">"document_type"</span><span class="p">:</span> <span class="s2">"json"</span><span class="p">,</span>
<a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a>        <span class="s2">"instructions"</span><span class="p">:</span> <span class="s2">"Extract the customer name, order total, and list of products purchased."</span>
<a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a>    <span class="p">}</span>
<a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a>
<a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a>    <span class="c1"># Send the request</span>
<a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/process"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a>
<a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a>    <span class="c1"># Print response</span>
<a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a>    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a>
<a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a href="#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
<a href="#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a>
<a href="#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test_type</span> <span class="o">==</span> <span class="s2">"json"</span><span class="p">:</span>
<a href="#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a>        <span class="n">test_json_processing</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">api_url</span><span class="p">)</span>
<a href="#__codelineno-7-53" id="__codelineno-7-53" name="__codelineno-7-53"></a>    <span class="c1"># Additional handlers for image and PDF processing</span>
<a href="#__codelineno-7-54" id="__codelineno-7-54" name="__codelineno-7-54"></a>
<a href="#__codelineno-7-55" id="__codelineno-7-55" name="__codelineno-7-55"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a href="#__codelineno-7-56" id="__codelineno-7-56" name="__codelineno-7-56"></a>    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>To run the test:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c"># Get the API endpoint</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nv">$apiEndpoint</span> <span class="p">=</span> <span class="p">./</span><span class="n">scripts</span><span class="p">/</span><span class="n">get_api_endpoint</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-AwsProfile</span> <span class="n">your-profile-name</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="c"># Test JSON document processing</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">python</span> <span class="n">examples</span><span class="p">/</span><span class="n">test_document_processor</span><span class="p">.</span><span class="n">py</span> <span class="p">-</span><span class="n">-api-url</span> <span class="nv">$apiEndpoint</span> <span class="p">-</span><span class="n">-test-type</span> <span class="n">json</span>
</code></pre></div>
<h2 id="benefits-of-this-approach">Benefits of This Approach</h2>
<p>This Lambda-based architecture offers several advantages:</p>
<ol>
<li><strong>Clean separation</strong>: Your existing infrastructure remains untouched</li>
<li><strong>Python ecosystem access</strong>: Use the latest LLM libraries and techniques</li>
<li><strong>Scalability</strong>: AWS Lambda auto-scales based on usage</li>
<li><strong>Cost-effectiveness</strong>: Pay only for what you use</li>
<li><strong>Security</strong>: API keys are stored securely in AWS Secrets Manager</li>
<li><strong>Infrastructure as code</strong>: Terraform ensures consistent deployments</li>
<li><strong>Containerization</strong>: Docker simplifies dependency management</li>
</ol>
<h2 id="integration-with-existing-systems">Integration with Existing Systems</h2>
<p>Existing applications can easily consume the API in any language:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// Java example</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.http.HttpClient</span><span class="p">;</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.http.HttpRequest</span><span class="p">;</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.http.HttpResponse</span><span class="p">;</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LambdaApiClient</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">;</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HttpClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LambdaApiClient</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">apiUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">;</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">.</span><span class="na">newHttpClient</span><span class="p">();</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">processDocument</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">documentData</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">instructions</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">            </span><span class="s">"{\"document_data\":%s,\"document_type\":\"json\",\"instructions\":\"%s\"}"</span><span class="p">,</span>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">            </span><span class="n">documentData</span><span class="p">,</span><span class="w"> </span><span class="n">instructions</span>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">        </span><span class="p">);</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">        </span><span class="n">HttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">            </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">apiUrl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"/process"</span><span class="p">))</span>
<a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">            </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="s">"application/json"</span><span class="p">)</span>
<a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">            </span><span class="p">.</span><span class="na">POST</span><span class="p">(</span><span class="n">HttpRequest</span><span class="p">.</span><span class="na">BodyPublishers</span><span class="p">.</span><span class="na">ofString</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a>
<a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpResponse</span><span class="p">.</span><span class="na">BodyHandlers</span><span class="p">.</span><span class="na">ofString</span><span class="p">());</span>
<a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>
<a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">statusCode</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">"API request failed: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">());</span>
<a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">();</span>
<a href="#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="p">}</span>
</code></pre></div>
<h2 id="conclusion-and-future-directions">Conclusion and Future Directions</h2>
<p>This approach lets you harness the power of Python-based LLMs in any enterprise environment through AWS Lambda functions. By creating a clean API boundary, you decouple your LLM implementation from existing systems while providing a stable interface for integration.</p>
<p>In future articles, we'll explore:</p>
<ol>
<li><strong>Java-based LLM applications</strong>: Approaches to building LLM applications directly in Java</li>
<li><strong>Monitoring LLM services</strong>: Implementing effective monitoring and logging </li>
<li><strong>Evaluation frameworks</strong>: Building systematic evaluation pipelines for LLM-based systems</li>
<li><strong>Cost optimization</strong>: Strategies to minimize costs in production LLM deployments</li>
</ol>
<p>The complete code for this solution is available in our <a href="https://github.com/yourusername/llm-lambda-api">GitHub repository</a>.</p>
<hr/>
<p>By leveraging the serverless paradigm, we can introduce powerful LLM capabilities to legacy systems without disrupting existing workflows or requiring major rewrites. This pragmatic approach enables organizations to benefit from the latest AI advancements regardless of their current technology stack. </p>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="Last update">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="April 13, 2025 16:05:08">April 13, 2025</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Created">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="April 13, 2025 16:05:08">April 13, 2025</span>
</span>
</aside>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: MLOps Fundamentals" class="md-footer__link md-footer__link--prev" href="../mlops-fundamentals/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                MLOps Fundamentals
              </div>
</div>
</a>
<a aria-label="Next: Overview" class="md-footer__link md-footer__link--next" href="../../blog/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Overview
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2025 ButterflAI
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/Vikramardham" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"></path></svg>
</a>
<a class="md-social__link" href="https://linkedin.com/company/ButterflAI" rel="noopener" target="_blank" title="linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>